<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gym Dashboard</title>
  <style>
    :root{
      --bg:#0b0b0c;
      --card:#121214;
      --muted:#9aa0a6;
      --text:#f5f6f7;
      --line:#202124;
      --good:#7CFC00;
      --bad:#ff6b6b;
      --warn:#ffd166;
    }
    /* ... ALL your existing CSS stays here ... */

    .danger{
      border-color: rgba(255, 107, 107, .35);
      color: var(--bad);
    }

    /* ---------------------------
       MODAL SCROLL FIX (mobile + desktop)
       - keeps modal within screen
       - allows scrolling inside the modal
    ---------------------------- */
    #logModal,
    #histModal,
    #rtModal{
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }

    /* the modal "card" (your inner <div>) */
    #logModal > div,
    #histModal > div,
    #rtModal > div{
      max-height:90vh;
      display:flex;
      flex-direction:column;
    }
    /* allow the long lists inside modals to scroll */
    #logModalSets,
    #rtExList{
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      max-height:50vh;
    }
    /* scrollable content inside modals */
    #logModalSets,
    #rtExList{
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      max-height:50vh;
    }
    /* keep action buttons visible in modals */
    #rtModal .btnRow,
    #logModal .btnRow{
      position:sticky;
      bottom:0;
      background:linear-gradient(
        to bottom,
        rgba(18,18,20,0),
        rgba(18,18,20,1) 35%
      );
      padding-top:10px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 16px 8px;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      background:rgba(11,11,12,.92);
      backdrop-filter: blur(10px);
      z-index:10;
    }
    h1{
      margin:0 0 6px 0;
      font-size:18px;
      letter-spacing:.5px;
      font-weight:700;
    }
    .sub{
      color:var(--muted);
      font-size:12px;
    }
    main{
      padding:14px 12px 80px;
      display:grid;
      gap:12px;
      max-width:1100px;
      margin:0 auto;
    }
    .grid2{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .grid2{grid-template-columns: 1fr 1fr;}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.4px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:11px;
      color:var(--muted);
      min-width: 120px;
      flex:1 1 140px;
    }
    input, select, button, textarea{
      background:#0f0f10;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:38px; resize:vertical;}
    input::placeholder{color:#666}
    button{
      cursor:pointer;
      background:#0f0f10;
      font-weight:600;
    }
    button:hover{border-color:#2a2b2f}
    .btnRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .pill strong{color:var(--text)}
    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      text-align:left;
      vertical-align:top;
    }
    th{
      color:var(--muted);
      font-weight:700;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.6px;
      background:#0f0f10;
    }
    tr:last-child td{border-bottom:none}
    .mono{font-variant-numeric: tabular-nums;}
    .good{color:var(--good); font-weight:700;}
    .bad{color:var(--bad); font-weight:700;}
    .warn{color:var(--warn); font-weight:700;}
    .muted{color:var(--muted)}
    .small{font-size:11px}
    .splitTabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      color:var(--muted);
      background:#0f0f10;
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .tab.active{
      color:var(--text);
      border-color:#2a2b2f;
    }
    .exerciseList{
      display:grid;
      gap:8px;
    }
    .exerciseItem{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#0f0f10;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .exerciseItem .left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .exerciseItem .title{
      font-size:13px;
      font-weight:700;
    }
    .exerciseItem .meta{
      font-size:11px;
      color:var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .exerciseItem .right{
      text-align:right;
      min-width:160px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .exerciseItem .right .line2{
      font-size:11px;
      color:var(--muted);
    }
    .badge{
      display:inline-block;
      padding:4px 8px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:11px;
      color:var(--text);
      background:#121214;
    }
    .calendar{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      margin-top:10px;
      user-select:none;
    }
    .calHead{
      font-size:10px;
      color:var(--muted);
      text-align:center;
      padding:4px 0;
    }
    .day{
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 0;
      text-align:center;
      font-size:12px;
      background:#0f0f10;
      cursor:pointer;
    }
    .day.off{opacity:.35; cursor:default;}
    .day.attended{
      border-color:#2a2b2f;
      outline:2px solid rgba(124,252,0,.25);
    }
    .day.attended .dot{
      display:block;
      margin:6px auto 0;
      width:6px; height:6px;
      border-radius:50%;
      background:var(--good);
    }
    .topRight{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .ghost{
      border-color:transparent;
      color:var(--muted);
    }
    .ghost:hover{border-color:var(--line)}
    .notice{
      border:1px dashed #2a2b2f;
      border-radius:12px;
      padding:10px;
      color:var(--muted);
      font-size:12px;
      background:#0f0f10;
    }
    .clickEx{cursor:pointer; text-decoration:underline; text-decoration-color:#2a2b2f;}
    .clickEx:hover{opacity:.85;}
    .divider{
      height:1px;
      background:var(--line);
      margin:10px 0;
    }
    .miniBtn{
      padding:8px 10px;
      font-size:12px;
    }
    .danger{
      border-color: rgba(255, 107, 107, .35);
      color: var(--bad);
    }
  </style>
</head>

<body>
<header>
  <h1>Gym Dashboard</h1>
  <div class="sub">Minimal tracker ‚Ä¢ lbs only ‚Ä¢ Protein goal 240g ‚Ä¢ No cardio ‚Ä¢ Rest days hidden</div>
</header>

<main>

  <div class="grid2">
    <!-- WEIGHT -->
    <section class="card">
      <div class="topRight">
        <h2>Weekly Weight Tracker</h2>
        <div class="row" style="gap:6px;">
          <button class="ghost" id="exportBtn" title="Download your data as a file">Export</button>
          <button class="ghost" id="importBtn" title="Import previously exported data">Import</button>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
          <button class="ghost" id="wipeAllBtn" title="Deletes everything saved in this app">Reset All Data</button>
        </div>
      </div>

      <div class="row">
        <label>Date
          <input type="date" id="bwDate" />
        </label>
        <label>Bodyweight (lbs)
          <input type="number" id="bwVal" placeholder="e.g., 198.6" step="0.1" />
        </label>
        <button id="bwAddBtn">Add Weight</button>
      </div>

      <div class="btnRow">
        <span class="pill"><span class="muted">Latest:</span> <strong class="mono" id="bwLatest">‚Äî</strong></span>
        <span class="pill"><span class="muted">Last Œî:</span> <strong class="mono" id="bwDelta">‚Äî</strong></span>
        <span class="pill"><span class="muted">7-day avg:</span> <strong class="mono" id="bwAvg">‚Äî</strong></span>
      </div>

      <div style="margin-top:10px;">
        <canvas id="bwChart" height="120"></canvas>
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>BW (lbs)</th>
              <th>Prev</th>
              <th>Œî</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="bwTable"></tbody>
        </table>
      </div>
    </section>

    <!-- ATTENDANCE -->
    <section class="card">
      <div class="topRight">
        <h2>Attendance (Tap days you went)</h2>
        <div class="row" style="gap:6px;">
          <button id="prevMonthBtn">‚óÄ</button>
          <span class="pill"><strong id="calTitle">‚Äî</strong></span>
          <button id="nextMonthBtn">‚ñ∂</button>
        </div>
      </div>

      <div class="calendar" id="calGrid"></div>

      <div class="btnRow">
        <span class="pill"><span class="muted">This month:</span> <strong class="mono" id="calCount">0</strong></span>
        <button id="clearMonthBtn">Clear This Month</button>
      </div>

      <div class="notice" style="margin-top:10px;">
        Rest days are hidden because we only record the days you actually went.
      </div>
    </section>
  </div>

  <!-- PROTEIN -->
  <section class="card">
    <h2>Protein Intake (Goal 240g)</h2>
    <div class="row">
      <label>Date
        <input type="date" id="pDate" />
      </label>
      <label>Morning (g)
        <input type="number" id="pMorning" placeholder="0" />
      </label>
      <label>Lunch (g)
        <input type="number" id="pLunch" placeholder="0" />
      </label>
      <label>Pre-Gym (g)
        <input type="number" id="pPre" placeholder="0" />
      </label>
      <label>Dinner (g)
        <input type="number" id="pDinner" placeholder="0" />
      </label>
      <label>Bedtime (g)
        <input type="number" id="pBed" placeholder="0" />
      </label>
      <button id="pSaveBtn">Save</button>
    </div>

    <div class="btnRow">
      <span class="pill"><span class="muted">Total:</span> <strong class="mono" id="pTotal">0</strong>g</span>
      <span class="pill"><span class="muted">Remaining:</span> <strong class="mono" id="pRemain">240</strong>g</span>
      <span class="pill"><span class="muted">Status:</span> <strong id="pStatus">‚Äî</strong></span>
    </div>
  </section>

  <div class="grid2">
    <!-- PPL ROUTINE -->
    <section class="card">
      <div class="topRight">
        <div>
          <h2 style="margin-bottom:6px;">Routine (Mon‚ÄìSun)</h2>
          <div class="small muted" id="activeRoutineMeta">‚Äî</div>
        </div>

        <div class="row" style="gap:6px;">
          <label style="min-width:220px; flex:0 0 auto;">
            Active Routine
            <select id="routineSelect"></select>
          </label>

          <button id="newRoutineBtn" class="miniBtn">New</button>
          <button id="editRoutineBtn" class="miniBtn">Edit</button>
          <button id="dupRoutineBtn" class="miniBtn">Duplicate</button>
          <button id="delRoutineBtn" class="miniBtn danger">Delete</button>

          <button id="startTodayBtn" class="miniBtn">Start Today</button>
        </div>
      </div>

      <div class="splitTabs" id="pplTabs"></div>
      <div class="exerciseList" id="pplList"></div>

      <div class="notice" style="margin-top:10px;">
        Tip: Tap ‚ÄúLog Sets‚Äù on an exercise to record sets/reps/weight. PR is based on your lifetime max for that exercise.
      </div>
    </section>

    <!-- LIFT PROGRESS LOG -->
    <section class="card">
      <div class="topRight">
        <h2>Lift Progress Log</h2>
        <div class="row" style="gap:6px;">
          <button id="liftViewTableBtn" class="miniBtn">Table</button>
          <button id="liftViewGraphBtn" class="miniBtn ghost">Graph</button>
          <button id="liftDownloadBtn" class="miniBtn ghost" title="Download current graph">Download PNG</button>
        </div>
      </div>

      <div class="row">
        <label>Exercise
          <select id="liftSearch"></select>
        </label>

        <label>Routine
          <select id="liftRoutine"></select>
        </label>

        <label>Date From
          <input type="date" id="liftFrom" />
        </label>

        <label>Date To
          <input type="date" id="liftTo" />
        </label>
      </div>

      <div class="row" style="margin-top:8px;">
        <label>Metric (Graph)
          <select id="liftMetric">
            <option value="top" selected>Top Weight</option>
            <option value="e1rm">Estimated 1RM (Epley)</option>
            <option value="vol">Volume</option>
          </select>
        </label>

        <label>Rows (Table)
          <select id="liftLimit">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="0">All</option>
          </select>
        </label>

        <button id="liftSearchBtn">Search</button>
        <button id="liftClearBtn" class="ghost">Clear</button>
      </div>

      <!-- TABLE -->
      <div id="liftTableWrap" style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Exercise</th>
              <th>Top Set</th>
              <th>Sets</th>
              <th>PR</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="liftTable"></tbody>
        </table>
      </div>

      <!-- GRAPH -->
      <div id="liftGraphWrap" style="margin-top:10px; display:none;">
        <canvas id="liftChart" height="140"></canvas>
        <div class="notice" style="margin-top:10px;">
          Weekly separators are shown as vertical lines for easier progress blocks.
        </div>
      </div>

      <div class="notice" style="margin-top:10px;">
        Tap an exercise name in the table to view history.
      </div>
    </section>
  </div>

  <!-- LOG SETS MODAL -->
  <div id="logModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
    <div style="max-width:520px; margin:40px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
      <div class="topRight">
        <div>
          <h2 style="margin:0;">Log Sets</h2>
          <div class="small muted" id="logRoutineLine">‚Äî</div>
        </div>
        <button id="logModalClose">Close</button>
      </div>

      <div class="notice" style="margin-top:10px;">
        <div><strong id="logModalExercise">‚Äî</strong></div>
        <div class="small muted">Enter what you actually did. Add/remove sets as needed.</div>
      </div>

      <div id="logPrevBox" class="notice" style="margin-top:10px; display:none;">
        <div class="small muted">Last time:</div>
        <div id="logPrevText" class="mono">‚Äî</div>
        <div class="btnRow" style="margin-top:8px;">
          <button id="logCopyLastBtn" type="button">Copy last time</button>
          <button id="logViewHistoryBtn" type="button" class="ghost">View history</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Date
          <input type="date" id="logModalDate" />
        </label>
      </div>

      <div id="logModalSets" style="margin-top:10px; display:grid; gap:8px;"></div>

      <div class="btnRow">
        <button id="logAddSetBtn">Add Set</button>
        <button id="logSaveBtn">Confirm & Save</button>
      </div>
    </div>
  </div>

  <!-- HISTORY MODAL -->
  <div id="histModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
    <div style="max-width:640px; margin:40px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
      <div class="topRight">
        <h2 style="margin:0;">Exercise History</h2>
        <button id="histCloseBtn">Close</button>
      </div>

      <div class="notice" style="margin-top:10px;">
        <div><strong id="histExercise">‚Äî</strong></div>
        <div class="small muted">Most recent first. Shows your saved set details (if available).</div>
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Top Set</th>
              <th>All Sets</th>
              <th>PR</th>
            </tr>
          </thead>
          <tbody id="histTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ROUTINE EDITOR MODAL -->
  <div id="rtModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;">
    <div style="max-width:760px; margin:40px auto; background:#121214; border:1px solid #202124; border-radius:14px; padding:12px;">
      <div class="topRight">
        <h2 style="margin:0;">Routine Editor</h2>
        <button id="rtCloseBtn">Close</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Routine Name
          <input id="rtName" placeholder="e.g., PPL (6 days)" />
        </label>
      </div>

      <div class="divider"></div>

      <div class="splitTabs" id="rtDayTabs"></div>

      <div class="row" style="margin-top:8px;">
        <label style="min-width:220px; flex:0 0 auto;">Day Label (optional)
          <input id="rtDayLabel" placeholder="e.g., Push / Pull / Legs / Upper" />
        </label>

        <label style="min-width:220px; flex:0 0 auto;">Rest Day?
          <select id="rtRestToggle">
            <option value="0" selected>No</option>
            <option value="1">Yes (hide day)</option>
          </select>
        </label>
      </div>

      <div id="rtDayRestNotice" class="notice" style="margin-top:10px; display:none;">
        This day is marked as a Rest Day. Exercises are kept but hidden on the dashboard.
      </div>

      <div class="divider"></div>

      <div class="row">
        <label style="min-width:280px; flex:1 1 280px;">Add Exercise (suggestions)
          <input id="rtAddExName" list="rtExSuggestions" placeholder="Start typing a known exercise name..." />
          <datalist id="rtExSuggestions"></datalist>
        </label>
        <label>Sets
          <input id="rtAddExSets" type="number" min="1" placeholder="3" />
        </label>
        <label>Reps
          <input id="rtAddExReps" placeholder="8‚Äì10" />
        </label>
        <button id="rtAddExBtn">Add</button>
      </div>

      <div id="rtExList" style="margin-top:10px; display:grid; gap:8px;"></div>

      <div class="divider"></div>

      <div class="btnRow">
        <button id="rtSaveBtn">Save Routine</button>
        <button id="rtCancelBtn" class="ghost">Cancel</button>
      </div>

      <div class="notice" style="margin-top:10px;">
        Swap replaces an exercise only for this day. Reorder uses Up/Down.
      </div>
    </div>
  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ---------------------------
   Storage helpers
---------------------------- */
const LS = {
  get(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    }catch{ return fallback; }
  },
  set(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }
};

const KEY_BW = "gym_bw_logs_v1";
const KEY_ATT = "gym_attendance_v1";
const KEY_PRO = "gym_protein_v1";
const KEY_LIFTS = "gym_lifts_v1";
const KEY_TARGETS = "gym_targets_v1";

const KEY_ROUTINES = "gym_routines_v1";
const KEY_ACTIVE_ROUTINE = "gym_active_routine_id_v1";

/* ---------------------------
   LOCAL date utils
---------------------------- */
function pad2(n){ return String(n).padStart(2,"0"); }
function localISODate(d){
  const dt = (d instanceof Date) ? d : new Date(d);
  return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
}
function todayISO(){ return localISODate(new Date()); }
function parseISO(s){
  const [y,m,dd]=s.split("-").map(Number);
  return new Date(y, m-1, dd);
}
function sameMonth(d, y, m){ return d.getFullYear()===y && d.getMonth()===m; }

function weekStartMonday(baseDate=new Date()){
  const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
  const dow = d.getDay(); // 0 Sun..6 Sat
  const delta = (dow === 0) ? 6 : (dow - 1);
  d.setDate(d.getDate() - delta);
  return d;
}
const DAY_KEYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
function dateForWeekdayIndex(dayIndex, baseDate=new Date()){
  const start = weekStartMonday(baseDate);
  const out = new Date(start);
  out.setDate(start.getDate() + dayIndex);
  return localISODate(out);
}

/* ---------------------------
   Normalization
---------------------------- */
function normExName(s){
  return String(s||"")
    .toLowerCase()
    .replace(/\s+/g," ")
    .trim();
}

/* ---------------------------
   UID helper
---------------------------- */
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

/* ---------------------------
   Default Routine Seed
---------------------------- */
function defaultRoutine(){
  return {
    id: uid(),
    name: "PPL",
    days: {

      Mon: { label:"Push", rest:false, exercises:[
        {name:"Incline Dumbbell Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Dumbbell Bench Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Chest Dips", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Lateral Raises", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Chest Flys", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Triceps Rope Pushdowns", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Overhead Dumbbell Triceps Extension", sets:3, reps:"12‚Äì15", notes:""},
      ]},

      Tue: { label:"Pull", rest:false, exercises:[
        {name:"Underhand Lat Pulldown", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Barbell Row", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Dumbbell Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Seated Cable Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Rear Delt Fly", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Barbell Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hammer Curl", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Dumbbell Alternating Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hanging Leg Raises", sets:3, reps:"12‚Äì15", notes:"Core"},
      ]},

      Wed: { label:"Legs", rest:false, exercises:[
        {name:"Barbell Back Squat", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Leg Press", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Goblet Squats", sets:3, reps:"12‚Äì15 steps", notes:""},
        {name:"Leg Curl Machine", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Standing Calf Raise", sets:3, reps:"15‚Äì20", notes:""},
        {name:"Leg Extensions", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Crunches", sets:3, reps:"20", notes:"Core"},
      ]},

      Thu: { label:"Push", rest:false, exercises:[
        {name:"Incline Dumbbell Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Dumbbell Bench Press", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Chest Dips", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Lateral Raises", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Chest Flys", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Triceps Rope Pushdowns", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Overhead Dumbbell Triceps Extension", sets:3, reps:"12‚Äì15", notes:""},
      ]},

      Fri: { label:"Pull", rest:false, exercises:[
        {name:"Underhand Lat Pulldown", sets:4, reps:"8‚Äì10", notes:""},
        {name:"Barbell Row", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Dumbbell Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Seated Cable Row", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Rear Delt Fly", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Barbell Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hammer Curl", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Dumbbell Alternating Curl", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Hanging Leg Raises", sets:3, reps:"12‚Äì15", notes:"Core"},
      ]},

      Sat: { label:"Legs", rest:false, exercises:[
        {name:"Barbell Back Squat", sets:4, reps:"6‚Äì8", notes:""},
        {name:"Leg Press", sets:3, reps:"10‚Äì12", notes:""},
        {name:"Goblet Squats", sets:3, reps:"12‚Äì15 steps", notes:""},
        {name:"Leg Curl Machine", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Standing Calf Raise", sets:3, reps:"15‚Äì20", notes:""},
        {name:"Leg Extensions", sets:3, reps:"12‚Äì15", notes:""},
        {name:"Cable Crunches", sets:3, reps:"20", notes:"Core"},
      ]},

      Sun: { label:"Rest", rest:true, exercises:[] }
    }
  };
}

/* ---------------------------
   Routines state
---------------------------- */
function loadRoutines(){
  let routines = LS.get(KEY_ROUTINES, null);
  if(!Array.isArray(routines) || routines.length === 0){
    routines = [defaultRoutine()];
    LS.set(KEY_ROUTINES, routines);
  }
  routines.forEach(r=>{
    if(!r.days) r.days = {};
    DAY_KEYS.forEach(k=>{
      if(!r.days[k]) r.days[k] = {label:"", rest:false, exercises:[]};
      if(!Array.isArray(r.days[k].exercises)) r.days[k].exercises = [];
      if(typeof r.days[k].rest !== "boolean") r.days[k].rest = !!r.days[k].rest;
      if(typeof r.days[k].label !== "string") r.days[k].label = String(r.days[k].label||"");
      r.days[k].exercises = r.days[k].exercises.map(e=>({
        name: String(e.name||e.ex||""),
        sets: Number(e.sets)||0,
        reps: String(e.reps||""),
        notes: String(e.notes||"")
      })).filter(e=>e.name);
    });
    if(!r.id) r.id = uid();
    if(!r.name) r.name = "Routine";
  });

  LS.set(KEY_ROUTINES, routines);

  let activeId = LS.get(KEY_ACTIVE_ROUTINE, null);
  if(!activeId || !routines.some(r=>r.id===activeId)){
    activeId = routines[0].id;
    LS.set(KEY_ACTIVE_ROUTINE, activeId);
  }
  return {routines, activeId};
}
let {routines, activeId: activeRoutineId} = loadRoutines();

function saveRoutines(){ LS.set(KEY_ROUTINES, routines); }
function setActiveRoutine(id){
  activeRoutineId = id;
  LS.set(KEY_ACTIVE_ROUTINE, id);
}
function getActiveRoutine(){
  return routines.find(r=>r.id===activeRoutineId) || routines[0];
}

/* ---------------------------
   Weight Tracker
---------------------------- */
let bwLogs = LS.get(KEY_BW, []);
function sortBW(){ bwLogs.sort((a,b)=>a.date.localeCompare(b.date)); }

const bwDate = document.getElementById("bwDate");
const bwVal  = document.getElementById("bwVal");
const bwAddBtn= document.getElementById("bwAddBtn");
const bwTable= document.getElementById("bwTable");
const bwLatest= document.getElementById("bwLatest");
const bwDelta= document.getElementById("bwDelta");
const bwAvg= document.getElementById("bwAvg");

bwDate.value = todayISO();

bwAddBtn.addEventListener("click", ()=>{
  const d = bwDate.value || todayISO();
  const v = Number(bwVal.value);
  if(!d || !isFinite(v)) return alert("Please enter date + bodyweight.");
  bwLogs = bwLogs.filter(x=>x.date !== d);
  bwLogs.push({date:d, bw:v});
  sortBW();
  LS.set(KEY_BW, bwLogs);
  bwVal.value = "";
  renderBW();
});

function bwStats(){
  sortBW();
  const latest = bwLogs[bwLogs.length-1];
  const prev = bwLogs[bwLogs.length-2];
  const delta = (latest && prev) ? (latest.bw - prev.bw) : null;

  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-6);
  const last7 = bwLogs.filter(x=>parseISO(x.date) >= cutoff);
  const avg = last7.length ? (last7.reduce((s,x)=>s+x.bw,0)/last7.length) : null;

  return {latest, prev, delta, avg, last7};
}

let bwChart;
function renderBW(){
  sortBW();
  const {latest, prev, delta, avg} = bwStats();

  bwLatest.textContent = latest ? `${latest.bw.toFixed(1)} lbs (${latest.date})` : "‚Äî";
  if(delta === null) bwDelta.textContent = "‚Äî";
  else {
    const sign = delta>0 ? "+" : "";
    bwDelta.textContent = `${sign}${delta.toFixed(1)} lbs`;
    bwDelta.className = "mono " + (delta>0 ? "bad" : (delta<0 ? "good" : ""));
  }
  bwAvg.textContent = avg ? `${avg.toFixed(1)} lbs` : "‚Äî";

  bwTable.innerHTML = "";
  for(let i=0;i<bwLogs.length;i++){
    const cur = bwLogs[i];
    const prevBW = bwLogs[i-1]?.bw ?? null;
    const dlt = (prevBW===null) ? null : (cur.bw - prevBW);
    const trend = dlt===null ? "‚Äî" : (dlt>0 ? "‚Üë" : (dlt<0 ? "‚Üì" : "‚Äî"));
    const dltTxt = dlt===null ? "‚Äî" : `${dlt>0?"+":""}${dlt.toFixed(1)}`;
    const cls = dlt===null ? "" : (dlt>0 ? "bad" : (dlt<0 ? "good" : ""));
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${cur.date}</td>
      <td class="mono">${cur.bw.toFixed(1)}</td>
      <td class="mono">${prevBW===null?"‚Äî":prevBW.toFixed(1)}</td>
      <td class="mono ${cls}">${dltTxt} ${trend}</td>
      <td><button data-delbw="${cur.date}">Delete</button></td>
    `;
    bwTable.appendChild(tr);
  }
  bwTable.querySelectorAll("button[data-delbw]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const d = btn.getAttribute("data-delbw");
      bwLogs = bwLogs.filter(x=>x.date!==d);
      LS.set(KEY_BW, bwLogs);
      renderBW();
    });
  });

  const labels = bwLogs.map(x=>x.date);
  const data = bwLogs.map(x=>x.bw);

  const ctx = document.getElementById("bwChart");
  if(bwChart) bwChart.destroy();
  bwChart = new Chart(ctx, {
    type:"line",
    data:{ labels, datasets:[{ label:"Bodyweight (lbs)", data, tension:.25, pointRadius:3 }] },
    options:{
      responsive:true,
      plugins:{ legend:{display:false}, tooltip:{mode:"index", intersect:false} },
      scales:{
        x:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}},
        y:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}}
      }
    }
  });
}

/* ---------------------------
   Attendance Calendar
---------------------------- */
let attendance = new Set(LS.get(KEY_ATT, []));

let calY = new Date().getFullYear();
let calM = new Date().getMonth();
const calTitle = document.getElementById("calTitle");
const calGrid = document.getElementById("calGrid");
const calCount = document.getElementById("calCount");

document.getElementById("prevMonthBtn").addEventListener("click", ()=>{
  calM--; if(calM<0){calM=11; calY--;}
  renderCal();
});
document.getElementById("nextMonthBtn").addEventListener("click", ()=>{
  calM++; if(calM>11){calM=0; calY++;}
  renderCal();
});
document.getElementById("clearMonthBtn").addEventListener("click", ()=>{
  const keep = [...attendance].filter(s=>{
    const d=parseISO(s);
    return !sameMonth(d, calY, calM);
  });
  attendance = new Set(keep);
  LS.set(KEY_ATT, [...attendance]);
  renderCal();
});

function renderCal(){
  const monthName = new Date(calY,calM,1).toLocaleString(undefined,{month:"long"});
  calTitle.textContent = `${monthName} ${calY}`;

  calGrid.innerHTML = "";
  const heads = ["S","M","T","W","T","F","S"];
  heads.forEach(h=>{
    const el=document.createElement("div");
    el.className="calHead";
    el.textContent=h;
    calGrid.appendChild(el);
  });

  const first = new Date(calY, calM, 1);
  const startDay = first.getDay();
  const daysInMonth = new Date(calY, calM+1, 0).getDate();

  for(let i=0;i<startDay;i++){
    const blank=document.createElement("div");
    blank.className="day off";
    blank.textContent="";
    calGrid.appendChild(blank);
  }

  let count=0;
  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(calY, calM, d);
    const s = localISODate(date);
    const cell=document.createElement("div");
    cell.className="day";
    cell.innerHTML = `<div>${d}</div>`;
    if(attendance.has(s)){
      cell.classList.add("attended");
      cell.innerHTML += `<span class="dot"></span>`;
      count++;
    }
    cell.addEventListener("click", ()=>{
      if(attendance.has(s)) attendance.delete(s);
      else attendance.add(s);
      LS.set(KEY_ATT, [...attendance]);
      renderCal();
    });
    calGrid.appendChild(cell);
  }
  calCount.textContent = String(count);
}

/* ---------------------------
   Protein
---------------------------- */
const PRO_GOAL = 240;
const pDate = document.getElementById("pDate");
const pMorning = document.getElementById("pMorning");
const pLunch = document.getElementById("pLunch");
const pPre = document.getElementById("pPre");
const pDinner = document.getElementById("pDinner");
const pBed = document.getElementById("pBed");
const pTotal = document.getElementById("pTotal");
const pRemain= document.getElementById("pRemain");
const pStatus= document.getElementById("pStatus");
let proteinMap = LS.get(KEY_PRO, {});

pDate.value = todayISO();

function loadProteinDay(d){
  const obj = proteinMap[d] || {morning:0,lunch:0,pre:0,dinner:0,bed:0};
  pMorning.value = obj.morning;
  pLunch.value = obj.lunch;
  pPre.value = obj.pre;
  pDinner.value = obj.dinner;
  pBed.value = obj.bed;
  renderProteinTotals();
}
function renderProteinTotals(){
  const total = (Number(pMorning.value)||0)+(Number(pLunch.value)||0)+(Number(pPre.value)||0)+(Number(pDinner.value)||0)+(Number(pBed.value)||0);
  pTotal.textContent = String(total);
  const rem = PRO_GOAL - total;
  pRemain.textContent = String(rem);
  if(total >= PRO_GOAL){
    pStatus.textContent = "Hit goal ‚úÖ";
    pStatus.className = "good";
  } else if(total >= PRO_GOAL*0.75){
    pStatus.textContent = "Almost there";
    pStatus.className = "warn";
  } else {
    pStatus.textContent = "Under goal";
    pStatus.className = "muted";
  }
}
[pMorning,pLunch,pPre,pDinner,pBed].forEach(inp=>inp.addEventListener("input", renderProteinTotals));
pDate.addEventListener("change", ()=>loadProteinDay(pDate.value));

document.getElementById("pSaveBtn").addEventListener("click", ()=>{
  const d = pDate.value || todayISO();
  proteinMap[d] = {
    morning:Number(pMorning.value)||0,
    lunch:Number(pLunch.value)||0,
    pre:Number(pPre.value)||0,
    dinner:Number(pDinner.value)||0,
    bed:Number(pBed.value)||0,
  };
  LS.set(KEY_PRO, proteinMap);
  alert("Saved ‚úÖ");
});

/* ---------------------------
   Lifts + PR helpers
---------------------------- */
let lifts = LS.get(KEY_LIFTS, []);

function ensureLiftCompatibility(){
  lifts = lifts.map(x=>{
    const ex = String(x.ex || x.exercise || "");
    const exNorm = x.exNorm || normExName(ex);
    return {
      ...x,
      ex,
      exNorm,
      routineId: x.routineId || "",
      routineName: x.routineName || "",
      dayKey: x.dayKey || ""
    };
  });
  LS.set(KEY_LIFTS, lifts);
}
ensureLiftCompatibility();

function liftStatsForExercise(exName){
  const n = normExName(exName);
  const exLifts = lifts.filter(x=> (x.exNorm || normExName(x.ex)) === n);

  const life = exLifts.length ? Math.max(...exLifts.map(x=>Number(x.weight)||0)) : null;

  const thisWeekStart = new Date(); thisWeekStart.setDate(thisWeekStart.getDate()-7);
  const lastWeekStart = new Date(); lastWeekStart.setDate(lastWeekStart.getDate()-14);

  const thisWeek = exLifts.filter(x=>parseISO(x.date) >= thisWeekStart);
  const lastWeek = exLifts.filter(x=>{
    const d = parseISO(x.date);
    return d >= lastWeekStart && d < thisWeekStart;
  });

  const thisWeekMax = thisWeek.length ? Math.max(...thisWeek.map(x=>Number(x.weight)||0)) : null;
  const lastWeekMax = lastWeek.length ? Math.max(...lastWeek.map(x=>Number(x.weight)||0)) : null;

  return { life, thisWeekMax, lastWeekMax };
}

function getLastLiftForExercise(exName){
  const n = normExName(exName);
  const exLifts = lifts
    .filter(x=> (x.exNorm || normExName(x.ex)) === n)
    .sort((a,b)=>b.date.localeCompare(a.date));
  return exLifts[0] || null;
}

function formatSetsDetail(lift){
  if(!lift) return "‚Äî";
  const topSet = (lift.weight && lift.reps) ? `${lift.weight} x ${lift.reps}` : "‚Äî";
  const details = Array.isArray(lift.details) && lift.details.length
    ? lift.details.map((s,i)=>`S${i+1}:${s.weight}x${s.reps}`).join("  ")
    : null;
  return `${lift.date} ‚Ä¢ Top: ${topSet}${details ? " ‚Ä¢ " + details : ""}`;
}

/* ---------------------------
   Routine UI
---------------------------- */
const routineSelect = document.getElementById("routineSelect");
const activeRoutineMeta = document.getElementById("activeRoutineMeta");
const newRoutineBtn = document.getElementById("newRoutineBtn");
const editRoutineBtn = document.getElementById("editRoutineBtn");
const dupRoutineBtn = document.getElementById("dupRoutineBtn");
const delRoutineBtn = document.getElementById("delRoutineBtn");

let activeDayIndex = 0; // Mon=0..Sun=6

function renderRoutineDropdown(){
  const prev = routineSelect.value || activeRoutineId;
  routineSelect.innerHTML = "";
  routines.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = r.name;
    routineSelect.appendChild(opt);
  });
  routineSelect.value = routines.some(r=>r.id===prev) ? prev : routines[0].id;
  setActiveRoutine(routineSelect.value);

  const ar = getActiveRoutine();
  activeRoutineMeta.textContent = `${ar.name} ‚Ä¢ ${DAY_KEYS.length} days`;
}

routineSelect.addEventListener("change", ()=>{
  setActiveRoutine(routineSelect.value);
  renderRoutineDropdown();
  renderPPL();
  renderLiftRoutineDropdown(); // keeps routine filters in sync
});

newRoutineBtn.addEventListener("click", ()=>{
  const base = defaultRoutine();
  base.name = `New Routine ${routines.length+1}`;
  DAY_KEYS.forEach(k=>{
    base.days[k].exercises = [];
    base.days[k].rest = (k==="Sun");
    if(k==="Sun") base.days[k].label = "Rest";
  });
  routines.push(base);
  saveRoutines();
  setActiveRoutine(base.id);
  renderRoutineDropdown();
  openRoutineEditor(base.id);
});

dupRoutineBtn.addEventListener("click", ()=>{
  const ar = getActiveRoutine();
  const copy = JSON.parse(JSON.stringify(ar));
  copy.id = uid();
  copy.name = `${ar.name} (Copy)`;
  routines.push(copy);
  saveRoutines();
  setActiveRoutine(copy.id);
  renderRoutineDropdown();
  renderPPL();
  renderLiftRoutineDropdown();
});

delRoutineBtn.addEventListener("click", ()=>{
  if(routines.length <= 1){
    alert("You must keep at least one routine.");
    return;
  }
  const ar = getActiveRoutine();
  const ok = confirm(`Delete routine "${ar.name}"? (Logs will NOT be deleted.)`);
  if(!ok) return;
  routines = routines.filter(r=>r.id!==ar.id);
  saveRoutines();
  setActiveRoutine(routines[0].id);
  renderRoutineDropdown();
  renderPPL();
  renderLiftRoutineDropdown();
});

editRoutineBtn.addEventListener("click", ()=>{
  openRoutineEditor(getActiveRoutine().id);
});

function getTodaySplitIndex(){
  const dow = new Date().getDay(); // Sun=0..Sat=6
  if(dow === 0) return 6;
  return dow - 1;
}

/* ---------------------------
   PPL display
---------------------------- */
const pplTabs = document.getElementById("pplTabs");
const pplList = document.getElementById("pplList");

function renderDayTabs(){
  pplTabs.innerHTML = "";
  const ar = getActiveRoutine();

  DAY_KEYS.forEach((k, idx)=>{
    const day = ar.days[k];
    const label = (day.label || "").trim();
    const rest = !!day.rest;

    const b = document.createElement("div");
    b.className = "tab" + (idx===activeDayIndex ? " active" : "");
    b.innerHTML = `
      <span>${k}</span>
      ${label ? `<span class="badge">${label}</span>` : ""}
      ${rest ? `<span class="badge">Rest</span>` : ""}
    `;
    b.addEventListener("click", ()=>{
      activeDayIndex = idx;
      renderPPL();
    });
    pplTabs.appendChild(b);
  });
}

function renderPPL(){
  renderDayTabs();

  const ar = getActiveRoutine();
  const dayKey = DAY_KEYS[activeDayIndex];
  const day = ar.days[dayKey];

  pplList.innerHTML = "";

  if(day.rest){
    const restCard = document.createElement("div");
    restCard.className = "notice";
    restCard.innerHTML = `
      <div><strong>${dayKey}</strong> is marked as a Rest Day.</div>
      <div class="small muted">Exercises are stored but hidden. Toggle rest off in the Routine Editor.</div>
    `;
    pplList.appendChild(restCard);
    renderLiftSearchDropdown();
    return;
  }

  const list = Array.isArray(day.exercises) ? day.exercises : [];

  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "notice";
    empty.textContent = "No exercises yet for this day. Click Edit to add exercises.";
    pplList.appendChild(empty);
    renderLiftSearchDropdown();
    return;
  }

  list.forEach(item=>{
    const ex = item.name;
    const {life, thisWeekMax, lastWeekMax} = liftStatsForExercise(ex);

    const isPRThisWeek = (life !== null && thisWeekMax !== null && thisWeekMax === life);
    const prBadge = isPRThisWeek ? `<span class="badge">üèÜ PR (this week)</span>` : ``;

    const card = document.createElement("div");
    card.className = "exerciseItem";
    card.innerHTML = `
      <div class="left">
        <div class="title">${ex}</div>
        <div class="meta">
          <span>${item.sets || "‚Äî"} sets</span>
          <span>‚Ä¢</span>
          <span>${item.reps || "‚Äî"} reps</span>
          ${item.notes ? `<span class="badge">${item.notes}</span>` : ""}
        </div>
      </div>
      <div class="right">
        <div class="line2">This week: <span class="mono">${thisWeekMax===null?"‚Äî":thisWeekMax}</span> lbs</div>
        <div class="line2">Last week: <span class="mono">${lastWeekMax===null?"‚Äî":lastWeekMax}</span> lbs</div>
        <div class="line2">Lifetime max: <span class="mono">${life===null?"‚Äî":life}</span> lbs</div>
        <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap;">
          ${prBadge}
          <button type="button" data-log="${ex}">Log Sets</button>
        </div>
      </div>
    `;

    const logBtn = card.querySelector('button[data-log]');
    if(logBtn){
      logBtn.addEventListener("click", ()=>{
        openLogModal(ex, Number(item.sets)||3, ar, dayKey, activeDayIndex);
      });
    }

    pplList.appendChild(card);
  });

  renderLiftSearchDropdown();
}

document.getElementById("startTodayBtn").addEventListener("click", ()=>{
  activeDayIndex = getTodaySplitIndex();
  renderPPL();
  document.getElementById("pplList").scrollIntoView({behavior:"smooth", block:"start"});
});

/* ---------------------------
   Lift Progress Log (Phase 4)
---------------------------- */
const liftTable = document.getElementById("liftTable");
const liftSearch = document.getElementById("liftSearch");
const liftRoutine = document.getElementById("liftRoutine");
const liftFrom = document.getElementById("liftFrom");
const liftTo = document.getElementById("liftTo");
const liftMetric = document.getElementById("liftMetric");
const liftLimit = document.getElementById("liftLimit");

const liftSearchBtn = document.getElementById("liftSearchBtn");
const liftClearBtn = document.getElementById("liftClearBtn");

const liftViewTableBtn = document.getElementById("liftViewTableBtn");
const liftViewGraphBtn = document.getElementById("liftViewGraphBtn");
const liftDownloadBtn = document.getElementById("liftDownloadBtn");

const liftTableWrap = document.getElementById("liftTableWrap");
const liftGraphWrap = document.getElementById("liftGraphWrap");

let liftView = "table"; // "table" | "graph"
let appliedLiftFilters = {
  ex: "",
  routineId: "",
  from: "",
  to: "",
  metric: "top",
  limit: 25
};

function collectAllExerciseNames(){
  const set = new Set();
  routines.forEach(r=>{
    DAY_KEYS.forEach(k=>{
      (r.days?.[k]?.exercises || []).forEach(e=>{
        if(e?.name) set.add(e.name);
      });
    });
  });
  lifts.forEach(x=>{ if(x.ex) set.add(x.ex); });
  return [...set].sort();
}

function renderLiftSearchDropdown(){
  const prev = liftSearch.value || "";
  const items = ["", ...collectAllExerciseNames()];
  liftSearch.innerHTML = "";
  items.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v === "" ? "All exercises" : v;
    liftSearch.appendChild(opt);
  });
  liftSearch.value = items.includes(prev) ? prev : "";
}

function renderLiftRoutineDropdown(){
  const prev = liftRoutine.value || "";
  liftRoutine.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "All routines";
  liftRoutine.appendChild(optAll);

  routines.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = r.name;
    liftRoutine.appendChild(opt);
  });

  liftRoutine.value = (prev && routines.some(r=>r.id===prev)) ? prev : "";
}

function applyLiftFiltersFromUI(){
  appliedLiftFilters = {
    ex: (liftSearch.value || "").trim(),
    routineId: (liftRoutine.value || "").trim(),
    from: (liftFrom.value || "").trim(),
    to: (liftTo.value || "").trim(),
    metric: (liftMetric.value || "top"),
    limit: Number(liftLimit.value || 25)
  };
}

function clearLiftFiltersUI(){
  liftSearch.value = "";
  liftRoutine.value = "";
  liftFrom.value = "";
  liftTo.value = "";
  liftMetric.value = "top";
  liftLimit.value = "25";
}

function getLiftFilteredData(){
  let arr = [...lifts];

  // exercise filter (normalized)
  if(appliedLiftFilters.ex){
    const n = normExName(appliedLiftFilters.ex);
    arr = arr.filter(x => (x.exNorm || normExName(x.ex)) === n);
  }

  // routine filter
  if(appliedLiftFilters.routineId){
    arr = arr.filter(x => String(x.routineId || "") === appliedLiftFilters.routineId);
  }

  // date range filter
  if(appliedLiftFilters.from){
    const f = parseISO(appliedLiftFilters.from);
    arr = arr.filter(x => parseISO(x.date) >= f);
  }
  if(appliedLiftFilters.to){
    const t = parseISO(appliedLiftFilters.to);
    arr = arr.filter(x => parseISO(x.date) <= t);
  }

  // sort newest for table, oldest for graph later
  arr.sort((a,b)=>b.date.localeCompare(a.date));

  // limit (table)
  if(liftView === "table"){
    const lim = Number(appliedLiftFilters.limit || 25);
    if(lim > 0) arr = arr.slice(0, lim);
  }

  return arr;
}

function renderLiftsTable(){
  liftTable.innerHTML = "";
  const visible = getLiftFilteredData();

  visible.forEach(x=>{
    const topSet = (x.weight && x.reps) ? `${x.weight} x ${x.reps}` : "‚Äî";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${x.date}</td>
      <td><span class="clickEx" data-hist="${x.ex}">${x.ex}</span></td>
      <td class="mono">${topSet}</td>
      <td class="mono">${x.sets ?? "‚Äî"}</td>
      <td>${x.pr ? '<span class="badge">üèÜ</span>' : ''}</td>
      <td><button data-dellift="${x.id}">Delete</button></td>
    `;
    liftTable.appendChild(tr);
  });

  liftTable.querySelectorAll("button[data-dellift]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-dellift");
      lifts = lifts.filter(x=>x.id!==id);
      LS.set(KEY_LIFTS, lifts);
      renderLiftSearchDropdown();
      renderLifts();   // rerun with applied filters
      renderPPL();
      buildRoutineExerciseSuggestions();
    });
  });

  liftTable.querySelectorAll("[data-hist]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const ex = el.getAttribute("data-hist");
      openHistoryModal(ex);
    });
  });
}

/* ---- Graph helpers ---- */
function estEpley1RM(weight, reps){
  const w = Number(weight)||0;
  const r = Number(reps)||0;
  if(!w || !r) return 0;
  return w * (1 + (r/30));
}
function calcVolume(lift){
  // Prefer details if present
  if(Array.isArray(lift.details) && lift.details.length){
    return lift.details.reduce((sum,s)=>sum + (Number(s.weight)||0)*(Number(s.reps)||0), 0);
  }
  const w = Number(lift.weight)||0;
  const r = Number(lift.reps)||0;
  const sets = Number(lift.sets)||1;
  return w * r * sets;
}
function weekKey(d){
  const ws = weekStartMonday(d);
  return `${ws.getFullYear()}-${pad2(ws.getMonth()+1)}-${pad2(ws.getDate())}`;
}

let liftChart; // chart.js instance

const weekSeparatorsPlugin = {
  id: "weekSeparators",
  beforeDraw(chart, args, pluginOptions){
    const cfg = chart?.config?.options?.plugins?.weekSeparators;
    if(!cfg || cfg.enabled !== true) return;

    const {ctx, chartArea} = chart;
    const xScale = chart.scales?.x;
    if(!ctx || !chartArea || !xScale) return;

    const labels = chart.data.labels || [];
    if(labels.length < 2) return;

    // find week boundaries by comparing week keys across consecutive points
    const boundaries = [];
    let prevKey = null;
    for(let i=0;i<labels.length;i++){
      const d = parseISO(labels[i]);
      const key = weekKey(d);
      if(prevKey !== null && key !== prevKey){
        boundaries.push(i);
      }
      prevKey = key;
    }

    ctx.save();
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(154,160,166,0.22)";

    boundaries.forEach(i=>{
      const x = xScale.getPixelForValue(labels[i]);
      ctx.beginPath();
      ctx.moveTo(x, chartArea.top);
      ctx.lineTo(x, chartArea.bottom);
      ctx.stroke();
    });

    ctx.restore();
  }
};

function renderLiftsGraph(){
  const visible = getLiftFilteredData()
    .slice() // copy
    .sort((a,b)=>a.date.localeCompare(b.date)); // oldest -> newest

  const labels = visible.map(x=>x.date);

  const metric = appliedLiftFilters.metric || "top";
  const data = visible.map(x=>{
    if(metric === "e1rm") return estEpley1RM(x.weight, x.reps);
    if(metric === "vol") return calcVolume(x);
    return Number(x.weight)||0; // top
  });

  const yLabel =
    metric === "e1rm" ? "Est. 1RM (lbs)" :
    metric === "vol" ? "Volume" :
    "Top Weight (lbs)";

  const ctx = document.getElementById("liftChart");
  if(liftChart) liftChart.destroy();

  liftChart = new Chart(ctx, {
    type:"line",
    data:{
      labels,
      datasets:[{
        label: yLabel,
        data,
        tension:.25,
        pointRadius:3,
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{mode:"index", intersect:false},
        weekSeparators:{enabled:true}
      },
      scales:{
        x:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}},
        y:{ticks:{color:"#9aa0a6"}, grid:{color:"#202124"}}
      }
    },
    plugins:[weekSeparatorsPlugin]
  });

  // If no data, show a friendly message
  if(labels.length === 0){
    // chart will just be empty; that's fine
  }
}

function setLiftView(next){
  liftView = next;

  if(liftView === "table"){
    liftTableWrap.style.display = "";
    liftGraphWrap.style.display = "none";
    liftViewTableBtn.classList.remove("ghost");
    liftViewGraphBtn.classList.add("ghost");
    liftDownloadBtn.classList.add("ghost");
    renderLiftsTable();
  } else {
    liftTableWrap.style.display = "none";
    liftGraphWrap.style.display = "";
    liftViewTableBtn.classList.add("ghost");
    liftViewGraphBtn.classList.remove("ghost");
    liftDownloadBtn.classList.remove("ghost");
    renderLiftsGraph();
  }
}

function renderLifts(){
  // uses appliedLiftFilters + current liftView
  if(liftView === "table") renderLiftsTable();
  else renderLiftsGraph();
}

liftViewTableBtn.addEventListener("click", ()=> setLiftView("table"));
liftViewGraphBtn.addEventListener("click", ()=> setLiftView("graph"));

liftSearchBtn.addEventListener("click", ()=>{
  applyLiftFiltersFromUI();
  renderLifts();
});

liftClearBtn.addEventListener("click", ()=>{
  clearLiftFiltersUI();
  applyLiftFiltersFromUI();
  setLiftView("table");
  renderLifts();
});

liftDownloadBtn.addEventListener("click", ()=>{
  if(!liftChart){
    alert("Switch to Graph view first.");
    return;
  }
  const url = liftChart.toBase64Image("image/png", 1);
  const a = document.createElement("a");
  a.href = url;
  a.download = `lift-graph-${localISODate(new Date())}.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

/* ---------------------------
   Log Sets Modal
---------------------------- */
const logModal = document.getElementById("logModal");
const logModalClose = document.getElementById("logModalClose");
const logModalExercise = document.getElementById("logModalExercise");
const logRoutineLine = document.getElementById("logRoutineLine");
const logModalDate = document.getElementById("logModalDate");
const logModalSets = document.getElementById("logModalSets");
const logAddSetBtn = document.getElementById("logAddSetBtn");
const logSaveBtn = document.getElementById("logSaveBtn");

const logPrevBox = document.getElementById("logPrevBox");
const logPrevText = document.getElementById("logPrevText");
const logCopyLastBtn = document.getElementById("logCopyLastBtn");
const logViewHistoryBtn = document.getElementById("logViewHistoryBtn");

let modalExerciseName = null;
let modalLastLift = null;
let modalRoutine = null;
let modalDayKey = null;
let modalDayIndex = null;

function openLogModal(exName, defaultSets=3, routineObj=null, dayKey="", dayIndex=0){
  modalExerciseName = exName;
  modalRoutine = routineObj;
  modalDayKey = dayKey;
  modalDayIndex = dayIndex;

  logModalExercise.textContent = exName;
  logRoutineLine.textContent = routineObj ? `${routineObj.name} ‚Ä¢ ${dayKey}` : "‚Äî";
  logModalDate.value = dateForWeekdayIndex(dayIndex, new Date()) || todayISO();

  modalLastLift = getLastLiftForExercise(exName);
  if(modalLastLift){
    logPrevBox.style.display = "block";
    logPrevText.textContent = formatSetsDetail(modalLastLift);
  } else {
    logPrevBox.style.display = "none";
    logPrevText.textContent = "‚Äî";
  }

  logModalSets.innerHTML = "";
  for(let i=0;i<defaultSets;i++) addSetRow();

  logModal.style.display = "block";
}

function closeLogModal(){
  logModal.style.display = "none";
  modalExerciseName = null;
  modalLastLift = null;
  modalRoutine = null;
  modalDayKey = null;
  modalDayIndex = null;
}

function renumberSetPills(){
  [...logModalSets.children].forEach((child, i)=>{
    const pillStrong = child.querySelector(".pill strong");
    if(pillStrong) pillStrong.textContent = String(i+1);
  });
}

function addSetRow(weight="", reps=""){
  const idx = logModalSets.children.length + 1;
  const row = document.createElement("div");
  row.className = "row";
  row.style.alignItems = "end";
  row.innerHTML = `
    <span class="pill"><span class="muted">Set</span> <strong class="mono">${idx}</strong></span>
    <label>Weight (lbs)
      <input type="number" step="0.5" inputmode="decimal" class="setWeight" placeholder="e.g., 75" value="${weight}" />
    </label>
    <label>Reps
      <input type="number" inputmode="numeric" class="setReps" placeholder="e.g., 8" value="${reps}" />
    </label>
    <button type="button" class="removeSetBtn">Remove</button>
  `;
  row.querySelector(".removeSetBtn").addEventListener("click", ()=>{
    row.remove();
    renumberSetPills();
  });
  logModalSets.appendChild(row);
}

logAddSetBtn.addEventListener("click", ()=> addSetRow());
logModalClose.addEventListener("click", closeLogModal);
logModal.addEventListener("click", (e)=>{ if(e.target === logModal) closeLogModal(); });

logCopyLastBtn.addEventListener("click", ()=>{
  if(!modalLastLift) return;
  logModalSets.innerHTML = "";

  if(Array.isArray(modalLastLift.details) && modalLastLift.details.length){
    modalLastLift.details.forEach(s=> addSetRow(String(s.weight ?? ""), String(s.reps ?? "")));
  } else {
    addSetRow(String(modalLastLift.weight ?? ""), String(modalLastLift.reps ?? ""));
  }
  renumberSetPills();
});

logViewHistoryBtn.addEventListener("click", ()=>{
  if(!modalExerciseName) return;
  openHistoryModal(modalExerciseName);
});

logSaveBtn.addEventListener("click", ()=>{
  if(!modalExerciseName) return;

  const date = logModalDate.value || todayISO();
  const setRows = [...logModalSets.querySelectorAll(".row")];

  const setsArr = [];
  for(const r of setRows){
    const w = Number(r.querySelector(".setWeight")?.value);
    const reps = Number(r.querySelector(".setReps")?.value);
    if(isFinite(w) && w > 0 && isFinite(reps) && reps > 0){
      setsArr.push({weight:w, reps:reps});
    }
  }

  if(setsArr.length === 0){
    alert("Enter at least one valid set (weight + reps).");
    return;
  }

  let top = setsArr[0];
  for(const s of setsArr){
    if(s.weight > top.weight) top = s;
  }

  const {life} = liftStatsForExercise(modalExerciseName);
  const isPR = (life === null) ? true : (top.weight > life);

  lifts.push({
    id: uid(),
    date,
    ex: modalExerciseName,
    exNorm: normExName(modalExerciseName),
    sets: setsArr.length,
    reps: top.reps,
    weight: top.weight,
    pr: isPR,
    details: setsArr,
    routineId: modalRoutine?.id || "",
    routineName: modalRoutine?.name || "",
    dayKey: modalDayKey || ""
  });

  lifts.sort((a,b)=>b.date.localeCompare(a.date));
  LS.set(KEY_LIFTS, lifts);

  closeLogModal();

  renderLiftSearchDropdown();
  renderLifts();      // Phase 4 respects applied filters
  renderPPL();
  buildRoutineExerciseSuggestions();

  document.getElementById("liftTable").scrollIntoView({behavior:"smooth", block:"start"});
});

/* ---------------------------
   History Modal
---------------------------- */
const histModal = document.getElementById("histModal");
const histCloseBtn = document.getElementById("histCloseBtn");
const histExercise = document.getElementById("histExercise");
const histTable = document.getElementById("histTable");

function closeHistoryModal(){ histModal.style.display = "none"; }
histCloseBtn.addEventListener("click", closeHistoryModal);
histModal.addEventListener("click", (e)=>{ if(e.target === histModal) closeHistoryModal(); });

function openHistoryModal(exName){
  histExercise.textContent = exName;
  const n = normExName(exName);

  const exLifts = lifts
    .filter(x=> (x.exNorm || normExName(x.ex)) === n)
    .sort((a,b)=>b.date.localeCompare(a.date))
    .slice(0, 12);

  histTable.innerHTML = "";

  exLifts.forEach(x=>{
    const topSet = (x.weight && x.reps) ? `${x.weight} x ${x.reps}` : "‚Äî";
    const allSets = Array.isArray(x.details) && x.details.length
      ? x.details.map((s,i)=>`S${i+1}:${s.weight}x${s.reps}`).join("  ")
      : "‚Äî";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${x.date}</td>
      <td class="mono">${topSet}</td>
      <td class="mono">${allSets}</td>
      <td>${x.pr ? '<span class="badge">üèÜ</span>' : ''}</td>
    `;
    histTable.appendChild(tr);
  });

  histModal.style.display = "block";
}

/* ---------------------------
   Routine Editor (unchanged)
---------------------------- */
const rtModal = document.getElementById("rtModal");
const rtCloseBtn = document.getElementById("rtCloseBtn");
const rtCancelBtn = document.getElementById("rtCancelBtn");
const rtSaveBtn = document.getElementById("rtSaveBtn");

const rtName = document.getElementById("rtName");
const rtDayTabs = document.getElementById("rtDayTabs");
const rtDayLabel = document.getElementById("rtDayLabel");
const rtRestToggle = document.getElementById("rtRestToggle");
const rtDayRestNotice = document.getElementById("rtDayRestNotice");

const rtAddExName = document.getElementById("rtAddExName");
const rtAddExSets = document.getElementById("rtAddExSets");
const rtAddExReps = document.getElementById("rtAddExReps");
const rtAddExBtn = document.getElementById("rtAddExBtn");
const rtExList = document.getElementById("rtExList");
const rtExSuggestions = document.getElementById("rtExSuggestions");

let editRoutineId = null;
let editDayIndex = 0;
let draftRoutine = null;

function buildRoutineExerciseSuggestions(){
  const list = collectAllExerciseNames();
  rtExSuggestions.innerHTML = "";
  list.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n;
    rtExSuggestions.appendChild(opt);
  });
}

function openRoutineEditor(routineId){
  const r = routines.find(x=>x.id===routineId);
  if(!r) return;

  editRoutineId = routineId;
  editDayIndex = activeDayIndex;
  draftRoutine = JSON.parse(JSON.stringify(r));

  rtName.value = draftRoutine.name;

  buildRoutineExerciseSuggestions();
  renderRtDayTabs();
  renderRtDayPanel();

  rtModal.style.display = "block";
}

function closeRoutineEditor(){
  rtModal.style.display = "none";
  editRoutineId = null;
  editDayIndex = 0;
  draftRoutine = null;
}

rtCloseBtn.addEventListener("click", closeRoutineEditor);
rtCancelBtn.addEventListener("click", closeRoutineEditor);
rtModal.addEventListener("click", (e)=>{ if(e.target === rtModal) closeRoutineEditor(); });

function renderRtDayTabs(){
  rtDayTabs.innerHTML = "";
  DAY_KEYS.forEach((k, idx)=>{
    const day = draftRoutine.days[k];
    const label = (day.label||"").trim();
    const rest = !!day.rest;

    const b = document.createElement("div");
    b.className = "tab" + (idx===editDayIndex ? " active" : "");
    b.innerHTML = `
      <span>${k}</span>
      ${label ? `<span class="badge">${label}</span>` : ""}
      ${rest ? `<span class="badge">Rest</span>` : ""}
    `;
    b.addEventListener("click", ()=>{
      editDayIndex = idx;
      renderRtDayTabs();
      renderRtDayPanel();
    });
    rtDayTabs.appendChild(b);
  });
}

function renderRtDayPanel(){
  const k = DAY_KEYS[editDayIndex];
  const day = draftRoutine.days[k];

  rtDayLabel.value = day.label || "";
  rtRestToggle.value = day.rest ? "1" : "0";
  rtDayRestNotice.style.display = day.rest ? "block" : "none";

  rtExList.innerHTML = "";
  const list = day.exercises || [];

  if(!list.length){
    const empty = document.createElement("div");
    empty.className = "notice";
    empty.textContent = "No exercises for this day yet.";
    rtExList.appendChild(empty);
    return;
  }

  list.forEach((ex, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.style.padding = "10px";
    wrap.style.background = "#0f0f10";

    wrap.innerHTML = `
      <div class="row" style="align-items:center;">
        <label style="flex:2 1 240px;">Name
          <input data-field="name" value="${ex.name || ""}" />
        </label>

        <label style="flex:0 0 120px;">Sets
          <input data-field="sets" type="number" min="1" value="${ex.sets || ""}" />
        </label>

        <label style="flex:1 1 160px;">Reps
          <input data-field="reps" value="${ex.reps || ""}" />
        </label>
      </div>

      <div class="row" style="margin-top:8px;">
        <label style="flex:1 1 100%;">Notes
          <textarea data-field="notes" placeholder="optional">${ex.notes || ""}</textarea>
        </label>
      </div>

      <div class="btnRow">
        <button type="button" class="miniBtn" data-up="${idx}">Up</button>
        <button type="button" class="miniBtn" data-down="${idx}">Down</button>
        <button type="button" class="miniBtn" data-swap="${idx}">Swap</button>
        <button type="button" class="miniBtn danger" data-remove="${idx}">Remove</button>
      </div>
    `;

    wrap.querySelectorAll("[data-field]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const field = inp.getAttribute("data-field");
        if(field === "sets"){
          day.exercises[idx][field] = Number(inp.value)||0;
        }else{
          day.exercises[idx][field] = inp.value;
        }
      });
    });

    wrap.querySelector("[data-up]")?.addEventListener("click", ()=>{
      if(idx<=0) return;
      const tmp = day.exercises[idx-1];
      day.exercises[idx-1] = day.exercises[idx];
      day.exercises[idx] = tmp;
      renderRtDayPanel();
    });

    wrap.querySelector("[data-down]")?.addEventListener("click", ()=>{
      if(idx>=day.exercises.length-1) return;
      const tmp = day.exercises[idx+1];
      day.exercises[idx+1] = day.exercises[idx];
      day.exercises[idx] = tmp;
      renderRtDayPanel();
    });

    wrap.querySelector("[data-remove]")?.addEventListener("click", ()=>{
      day.exercises.splice(idx,1);
      renderRtDayPanel();
    });

    wrap.querySelector("[data-swap]")?.addEventListener("click", ()=>{
      const cur = day.exercises[idx]?.name || "";
      const next = prompt(`Swap this exercise for what? (Day-specific)\nCurrent: ${cur}`, cur);
      if(next === null) return;
      const trimmed = String(next).trim();
      if(!trimmed) return;
      day.exercises[idx].name = trimmed;
      renderRtDayPanel();
    });

    rtExList.appendChild(wrap);
  });
}

rtDayLabel.addEventListener("input", ()=>{
  const k = DAY_KEYS[editDayIndex];
  draftRoutine.days[k].label = rtDayLabel.value;
  renderRtDayTabs();
});
rtRestToggle.addEventListener("change", ()=>{
  const k = DAY_KEYS[editDayIndex];
  draftRoutine.days[k].rest = (rtRestToggle.value === "1");
  if(draftRoutine.days[k].rest && !draftRoutine.days[k].label){
    draftRoutine.days[k].label = "Rest";
    rtDayLabel.value = "Rest";
  }
  rtDayRestNotice.style.display = draftRoutine.days[k].rest ? "block" : "none";
  renderRtDayTabs();
});

rtAddExBtn.addEventListener("click", ()=>{
  const k = DAY_KEYS[editDayIndex];
  const day = draftRoutine.days[k];

  const name = String(rtAddExName.value||"").trim();
  const sets = Number(rtAddExSets.value)||0;
  const reps = String(rtAddExReps.value||"").trim();

  if(!name) return alert("Enter an exercise name.");
  if(!sets || sets <= 0) return alert("Enter sets (number).");
  if(!reps) return alert("Enter reps (e.g., 8‚Äì10).");

  day.exercises.push({name, sets, reps, notes:""});
  rtAddExName.value = "";
  rtAddExSets.value = "";
  rtAddExReps.value = "";

  renderRtDayPanel();
  buildRoutineExerciseSuggestions();
  renderLiftSearchDropdown();
});

rtSaveBtn.addEventListener("click", ()=>{
  if(!draftRoutine) return;

  const name = String(rtName.value||"").trim();
  if(!name) return alert("Routine needs a name.");
  draftRoutine.name = name;

  const idx = routines.findIndex(r=>r.id===editRoutineId);
  if(idx < 0) return;

  routines[idx] = draftRoutine;
  saveRoutines();

  setActiveRoutine(draftRoutine.id);

  closeRoutineEditor();
  renderRoutineDropdown();
  renderPPL();
  renderLiftRoutineDropdown();
  buildRoutineExerciseSuggestions();
});

/* ---------------------------
   Export / Import / Reset
---------------------------- */
const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");

function buildExportPayload(){
  return {
    v: 2,
    exportedAt: new Date().toISOString(),
    bwLogs: LS.get(KEY_BW, []),
    attendance: LS.get(KEY_ATT, []),
    proteinMap: LS.get(KEY_PRO, {}),
    lifts: LS.get(KEY_LIFTS, []),
    routines: LS.get(KEY_ROUTINES, []),
    activeRoutineId: LS.get(KEY_ACTIVE_ROUTINE, null)
  };
}
function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
exportBtn.addEventListener("click", ()=>{
  const payload = buildExportPayload();
  const stamp = localISODate(new Date());
  downloadJSON(`gym-dashboard-${stamp}.json`, payload);
});
importBtn.addEventListener("click", ()=>{
  importFile.value = "";
  importFile.click();
});
importFile.addEventListener("change", async ()=>{
  const file = importFile.files?.[0];
  if(!file) return;

  try{
    const text = await file.text();
    const data = JSON.parse(text);

    const bw = Array.isArray(data.bwLogs) ? data.bwLogs : null;
    const att = Array.isArray(data.attendance) ? data.attendance : null;
    const pro = (data.proteinMap && typeof data.proteinMap === "object") ? data.proteinMap : null;
    const lf = Array.isArray(data.lifts) ? data.lifts : null;
    const rts = Array.isArray(data.routines) ? data.routines : null;
    const arId = (typeof data.activeRoutineId === "string" || data.activeRoutineId === null) ? data.activeRoutineId : null;

    if(!bw || !att || !pro || !lf || !rts){
      alert("That file doesn‚Äôt look like a valid export from this dashboard.");
      return;
    }

    const ok = confirm("Import will overwrite your current saved data on this browser. Continue?");
    if(!ok) return;

    LS.set(KEY_BW, bw);
    LS.set(KEY_ATT, att);
    LS.set(KEY_PRO, pro);
    LS.set(KEY_LIFTS, lf);
    LS.set(KEY_ROUTINES, rts);
    LS.set(KEY_ACTIVE_ROUTINE, arId);

    bwLogs = LS.get(KEY_BW, []);
    attendance = new Set(LS.get(KEY_ATT, []));
    proteinMap = LS.get(KEY_PRO, {});
    lifts = LS.get(KEY_LIFTS, []);
    ensureLiftCompatibility();

    ({routines, activeId: activeRoutineId} = loadRoutines());

    renderBW();
    renderCal();
    loadProteinDay(todayISO());

    renderRoutineDropdown();
    activeDayIndex = getTodaySplitIndex();
    renderPPL();

    renderLiftSearchDropdown();
    renderLiftRoutineDropdown();
    clearLiftFiltersUI();
    applyLiftFiltersFromUI();
    setLiftView("table");

    buildRoutineExerciseSuggestions();

    alert("Imported ‚úÖ");
  }catch(e){
    alert("Import failed. Make sure you selected a valid JSON export file.");
  }
});

document.getElementById("wipeAllBtn").addEventListener("click", ()=>{
  const ok = confirm("Reset ALL saved gym data on this device/browser?");
  if(!ok) return;
  localStorage.removeItem(KEY_BW);
  localStorage.removeItem(KEY_ATT);
  localStorage.removeItem(KEY_PRO);
  localStorage.removeItem(KEY_LIFTS);
  localStorage.removeItem(KEY_TARGETS);
  localStorage.removeItem(KEY_ROUTINES);
  localStorage.removeItem(KEY_ACTIVE_ROUTINE);
  location.reload();
});

/* ---------------------------
   Init
---------------------------- */
renderBW();
renderCal();
loadProteinDay(todayISO());

renderRoutineDropdown();
activeDayIndex = getTodaySplitIndex();
renderPPL();

renderLiftSearchDropdown();
renderLiftRoutineDropdown();
applyLiftFiltersFromUI();
setLiftView("table"); // default view

buildRoutineExerciseSuggestions();
</script>
</body>
</html>
